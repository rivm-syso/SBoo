#' @title DynApproxSolve
#' @name DynApproxSolve
#' @description This soolver solves system of States for 1rst order k(i,j) and 
#' emissions dynamically. 
#' Input is a data frame with three columns (Abbr, Emis and Timed) or a list of 
#' approx functions describing the emissions over time for each state. If a data frame is 
#' given as input, the approx functions are made for you in the solver. 
#' @param ParentModule SBcore object; to access SimpleBoxODE, states etc. 
#' too much and to diverse to put them in parameters and complicate the execute method
#' @param tmax time [s] for the simulation period
#' @param nTIMES number of timesteps
#' @param EmisAsPulse T is a pulse-type emission, false is not
#' @return see: ode()
DynApproxSolve = function(ParentModule, tmax = 1e10, nTIMES = 100, ApproxFun = T) {
  
  SB.K = ParentModule$SB.k
  SBNames = colnames(SB.K)
  SB.m0 <- rep(0, length(SBNames))
  SBtime <- seq(0,tmax,length.out = nTIMES)
  vEmis <- ParentModule$emissions
  
  out <- deSolve::ode(
    y = as.numeric(SB.m0),
    times = SBtime ,
    func = ParentModule$ODEapprox,
    parms = list(K = SB.K, SBNames=SBNames, emislist= vEmis),
    rtol = 1e-11, atol = 1e-3)

  colnames(out)[1:length(SBNames)+1] <- SBNames
  colnames(out)[grep("signal",colnames(out))] <- paste("emis",SBNames,sep = "2")
  as.data.frame(out) 
  
  attr(out, "SolverType") <- "ApproxDynamic"
  
  return(out)

}